# LTTH Electron Release Workflow
# Builds and publishes releases to GitHub Releases

name: Electron Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.0.0)'
        required: true
        type: string
      draft:
        description: 'Create as draft release'
        required: false
        type: boolean
        default: true
      prerelease:
        description: 'Mark as pre-release'
        required: false
        type: boolean
        default: false

# Default permissions
permissions:
  contents: read

env:
  NODE_VERSION: '20'
  ELECTRON_CACHE: ${{ github.workspace }}/.cache/electron
  ELECTRON_BUILDER_CACHE: ${{ github.workspace }}/.cache/electron-builder

jobs:
  # ============================================================================
  # Prepare Release
  # ============================================================================
  prepare:
    name: Prepare Release
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "tag=v${VERSION}" >> $GITHUB_OUTPUT
          echo "Release version: ${VERSION}"

  # ============================================================================
  # Build Windows
  # ============================================================================
  build-windows:
    name: Build (Windows)
    runs-on: windows-latest
    needs: prepare
    permissions:
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Cache Electron
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.ELECTRON_CACHE }}
            ${{ env.ELECTRON_BUILDER_CACHE }}
          key: electron-${{ runner.os }}-${{ hashFiles('package-lock.json') }}

      - name: Install dependencies
        run: npm ci

      - name: Install app dependencies
        run: cd app && npm ci

      - name: Rebuild native modules
        run: npm run rebuild
        continue-on-error: true

      - name: Build CSS
        run: npm run build:css
        continue-on-error: true

      - name: Build Electron (Windows)
        run: npm run build:win
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-windows
          path: |
            dist/*.exe
            dist/*.exe.blockmap
            dist/latest.yml
          retention-days: 1

  # ============================================================================
  # Build macOS
  # ============================================================================
  build-macos:
    name: Build (macOS)
    runs-on: macos-latest
    needs: prepare
    permissions:
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Cache Electron
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.ELECTRON_CACHE }}
            ${{ env.ELECTRON_BUILDER_CACHE }}
          key: electron-${{ runner.os }}-${{ hashFiles('package-lock.json') }}

      - name: Install dependencies
        run: npm ci

      - name: Install app dependencies
        run: cd app && npm ci

      - name: Rebuild native modules
        run: npm run rebuild
        continue-on-error: true

      - name: Build CSS
        run: npm run build:css
        continue-on-error: true

      - name: Build Electron (macOS)
        run: npm run build:mac
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Uncomment for notarization
          # CSC_LINK: ${{ secrets.MAC_CERTS }}
          # CSC_KEY_PASSWORD: ${{ secrets.MAC_CERTS_PASSWORD }}
          # APPLE_ID: ${{ secrets.APPLE_ID }}
          # APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          # APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-macos
          path: |
            dist/*.dmg
            dist/*.dmg.blockmap
            dist/*.zip
            dist/latest-mac.yml
          retention-days: 1

  # ============================================================================
  # Build Linux
  # ============================================================================
  build-linux:
    name: Build (Linux)
    runs-on: ubuntu-latest
    needs: prepare
    permissions:
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Cache Electron
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.ELECTRON_CACHE }}
            ${{ env.ELECTRON_BUILDER_CACHE }}
          key: electron-${{ runner.os }}-${{ hashFiles('package-lock.json') }}

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.0-dev librsvg2-dev

      - name: Install dependencies
        run: npm ci

      - name: Install app dependencies
        run: cd app && npm ci

      - name: Rebuild native modules
        run: npm run rebuild
        continue-on-error: true

      - name: Build CSS
        run: npm run build:css
        continue-on-error: true

      - name: Build Electron (Linux)
        run: npm run build:linux
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-linux
          path: |
            dist/*.AppImage
            dist/*.deb
            dist/*.rpm
            dist/latest-linux.yml
          retention-days: 1

  # ============================================================================
  # Create Release
  # ============================================================================
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [prepare, build-windows, build-macos, build-linux]
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-windows
          path: dist/

      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-macos
          path: dist/

      - name: Download Linux artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-linux
          path: dist/

      - name: List artifacts
        run: ls -la dist/

      - name: Generate release notes
        id: notes
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          cat << EOF > release-notes.md
          ## LTTH Desktop v${VERSION}
          
          ### Downloads
          
          | Platform | Download |
          |----------|----------|
          | Windows | \`LTTH-${VERSION}-win-x64.exe\` |
          | macOS (Intel) | \`LTTH-${VERSION}-mac-x64.dmg\` |
          | macOS (Apple Silicon) | \`LTTH-${VERSION}-mac-arm64.dmg\` |
          | Linux (AppImage) | \`LTTH-${VERSION}.AppImage\` |
          | Linux (Debian) | \`LTTH-${VERSION}-linux-x64.deb\` |
          
          ### Installation
          
          1. Download the appropriate file for your platform
          2. Run the installer (Windows) or mount the DMG (macOS) or run the AppImage (Linux)
          3. The app will automatically start the backend server
          4. Your browser will open to the dashboard
          
          ### What's New
          
          See [CHANGELOG](https://github.com/Loggableim/ltth_dev/blob/main/CHANGELOG.txt) for details.
          
          ---
          
          **Full Changelog**: https://github.com/Loggableim/ltth_dev/compare/v${VERSION}...v${VERSION}
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.prepare.outputs.tag }}
          name: "LTTH Desktop v${{ needs.prepare.outputs.version }}"
          body_path: release-notes.md
          draft: ${{ github.event.inputs.draft == 'true' || github.event_name == 'push' }}
          prerelease: ${{ github.event.inputs.prerelease == 'true' }}
          files: |
            dist/*.exe
            dist/*.dmg
            dist/*.zip
            dist/*.AppImage
            dist/*.deb
            dist/*.rpm
            dist/*.yml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================================
  # Cleanup
  # ============================================================================
  cleanup:
    name: Cleanup
    runs-on: ubuntu-latest
    needs: release
    if: always()
    permissions:
      actions: write
    
    steps:
      - name: Delete artifacts
        uses: geekyeggo/delete-artifact@v4
        with:
          name: |
            release-windows
            release-macos
            release-linux
          failOnError: false
