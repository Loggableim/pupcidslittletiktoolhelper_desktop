<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Config Import - Pup Cid's Little TikTok Helper</title>
    <link rel="stylesheet" href="/css/themes.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--color-bg-primary, #0f0f1e);
            color: var(--color-text-primary, #ffffff);
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--color-border, #2a2a3e);
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header p {
            color: var(--color-text-muted, #888);
            font-size: 1.1rem;
        }

        .card {
            background: var(--color-bg-secondary, #1a1a2e);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            border: 1px solid var(--color-border, #2a2a3e);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .card h2 {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: var(--color-text-primary, #ffffff);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--color-text-primary, #ffffff);
        }

        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--color-border, #2a2a3e);
            border-radius: 8px;
            background: var(--color-bg-tertiary, #0f0f1e);
            color: var(--color-text-primary, #ffffff);
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-right: 10px;
        }

        .button-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .button-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .button-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .button-secondary {
            background: var(--color-bg-tertiary, #2a2a3e);
            color: var(--color-text-primary, #ffffff);
            border: 1px solid var(--color-border, #2a2a3e);
        }

        .button-secondary:hover {
            background: var(--color-bg-secondary, #3a3a4e);
        }

        .alert {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.show {
            display: block;
        }

        .alert-success {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            color: #4ade80;
            white-space: pre-line; /* Preserve line breaks */
            text-align: left; /* Better for multi-line messages */
            font-family: inherit; /* Use normal font, not monospace */
        }

        .alert-error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #f87171;
        }

        .alert-warning {
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid rgba(251, 191, 36, 0.3);
            color: #fbbf24;
        }

        .alert-info {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: #60a5fa;
        }

        .findings {
            margin-top: 20px;
            padding: 16px;
            background: var(--color-bg-tertiary, #0f0f1e);
            border-radius: 8px;
            display: none;
        }

        .findings.show {
            display: block;
        }

        .findings h3 {
            margin-bottom: 12px;
            color: var(--color-text-primary, #ffffff);
        }

        .findings ul {
            list-style: none;
            padding-left: 0;
        }

        .findings li {
            padding: 8px 12px;
            margin-bottom: 8px;
            background: var(--color-bg-secondary, #1a1a2e);
            border-radius: 6px;
            border-left: 3px solid #667eea;
        }

        .findings li.found {
            border-left-color: #4ade80;
        }

        .findings li.not-found {
            border-left-color: #f87171;
            opacity: 0.5;
        }

        .help-section {
            background: var(--color-bg-tertiary, #0f0f1e);
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .help-section h3 {
            margin-bottom: 12px;
            color: #667eea;
        }

        .help-section ol {
            padding-left: 20px;
            margin-bottom: 12px;
        }

        .help-section li {
            margin-bottom: 8px;
        }

        .help-section .note {
            margin-top: 16px;
            padding: 12px;
            background: rgba(251, 191, 36, 0.1);
            border-radius: 6px;
            color: #fbbf24;
        }

        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            margin-right: 8px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 20px;
        }

        .stat-card {
            background: var(--color-bg-tertiary, #0f0f1e);
            padding: 16px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--color-text-muted, #888);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì• Config Import</h1>
            <p>Import your settings from an old installation</p>
        </div>

        <!-- Help Section -->
        <div class="card">
            <div class="help-section">
                <h3>‚ÑπÔ∏è How to use this tool</h3>
                <ol>
                    <li>Enter the full path to your old installation directory (or select the main folder containing an 'app/' subdirectory)</li>
                    <li>Optional: Enter a custom name for the imported profile</li>
                    <li>Click "Validate Path" to check if configuration files exist</li>
                    <li>If the path is valid, click "Import Settings" to import your data</li>
                </ol>
                <div class="note">
                    <strong>‚ö†Ô∏è Important:</strong> If a profile with the same name exists, a timestamp will be added automatically to avoid conflicts. The system will automatically search for config files in the app/ subdirectory if they're not found in the main directory.
                </div>
                <div class="note" style="margin-top: 12px; background: rgba(248, 113, 113, 0.1); color: #f87171;">
                    <strong>üö® Before Importing:</strong> Close the old installation of the application if it's running. Database files that are currently in use may not be imported correctly due to file locks. This is especially important on Windows systems.
                </div>
            </div>
        </div>

        <!-- Import Form -->
        <div class="card">
            <h2>Import Settings</h2>

            <!-- Alert Messages -->
            <div id="alert" class="alert"></div>

            <div class="form-group">
                <label for="importPath">Old Installation Path:</label>
                <input 
                    type="text" 
                    id="importPath" 
                    placeholder="e.g., C:\old-installation\pupcidslittletiktokhelper"
                >
            </div>

            <div class="form-group">
                <label for="profileName">Profile Name (optional):</label>
                <input 
                    type="text" 
                    id="profileName" 
                    placeholder="e.g., imported-config (leave empty for auto-generated name)"
                    maxlength="50"
                    pattern="[a-zA-Z0-9_-]*"
                >
                <small style="color: var(--color-text-muted, #888); display: block; margin-top: 4px;">
                    This name will be used for the imported profile. Only letters, numbers, hyphens, and underscores are allowed. If a profile with this name already exists, a timestamp will be added automatically.
                </small>
            </div>

            <div>
                <button class="button button-secondary" id="validateBtn">
                    <span id="validateText">üîç Validate Path</span>
                </button>
                <button class="button button-primary" id="importBtn" disabled>
                    <span id="importText">üì• Import Settings</span>
                </button>
            </div>

            <!-- Findings -->
            <div id="findings" class="findings">
                <h3>Found Configuration Files:</h3>
                <ul id="findingsList"></ul>
            </div>
        </div>

        <!-- Import Warnings -->
        <div id="warningsCard" class="card" style="display: none; border-left: 4px solid #fbbf24;">
            <h2>‚ö†Ô∏è Import Warnings</h2>
            <div id="warningsList" style="background: rgba(251, 191, 36, 0.1); padding: 16px; border-radius: 8px; margin-top: 12px;">
                <ul id="warningsContent" style="list-style-type: disc; padding-left: 20px; margin: 0;">
                </ul>
            </div>
            <div style="margin-top: 12px; padding: 12px; background: var(--color-bg-tertiary, #0f0f1e); border-radius: 6px; font-size: 0.9rem; color: var(--color-text-muted, #888);">
                üí° <strong>Tip:</strong> If you see warnings about database locks or files in use, close the old installation and try importing again.
            </div>
        </div>

        <!-- Import Logs -->
        <div id="logsCard" class="card" style="display: none;">
            <h2>üìã Import Log</h2>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <span style="color: var(--color-text-muted, #888); font-size: 0.9rem;">Detailed import progress</span>
                <button id="toggleLogs" class="button" style="padding: 6px 12px; font-size: 0.85rem;">
                    Show Details
                </button>
            </div>
            <div id="logsContent" style="display: none; background: var(--color-bg-tertiary, #0f0f1e); padding: 16px; border-radius: 8px; max-height: 400px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 0.85rem;">
            </div>
        </div>

        <!-- Import Results -->
        <div id="resultsCard" class="card" style="display: none;">
            <h2>‚úÖ Import Results</h2>
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="userConfigsCount">0</div>
                    <div class="stat-label">User Profiles</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="userDataCount">0</div>
                    <div class="stat-label">User Data Files</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="uploadsCount">0</div>
                    <div class="stat-label">Uploaded Files</div>
                </div>
                <div class="stat-card" id="pluginsCard" style="display: none;">
                    <div class="stat-number" id="pluginsCount">0</div>
                    <div class="stat-label">Plugin Data Files</div>
                </div>
                <div class="stat-card" id="legacyDbCard" style="display: none;">
                    <div class="stat-number" id="legacyDatabaseCount">0</div>
                    <div class="stat-label">Legacy Database</div>
                </div>
                <div class="stat-card" id="legacyDataCard" style="display: none;">
                    <div class="stat-number" id="legacyDataCount">0</div>
                    <div class="stat-label">Legacy Data Files</div>
                </div>
            </div>
            
            <!-- Profile Switching Reminder -->
            <div id="profileSwitchReminder" style="display: none; margin-top: 20px; padding: 16px; background: rgba(251, 191, 36, 0.1); border-left: 4px solid #fbbf24; border-radius: 8px;">
                <h3 style="color: #fbbf24; margin-bottom: 8px;">‚ö†Ô∏è Don't Forget to Switch Profiles!</h3>
                <p style="margin-bottom: 8px;">Your imported settings won't appear until you:</p>
                <ol style="padding-left: 20px; margin-bottom: 8px;">
                    <li>Go to <strong>Settings ‚Üí User Profiles</strong></li>
                    <li>Select the imported profile (<span id="importedProfileName" style="color: #60a5fa;">default</span>)</li>
                    <li>Restart the application</li>
                </ol>
                <p style="color: var(--color-text-muted, #888); font-size: 0.9rem;">
                    üí° The import was successful, but profiles must be manually activated.
                </p>
            </div>
        </div>
    </div>

    <script>
        const importPathInput = document.getElementById('importPath');
        const profileNameInput = document.getElementById('profileName');
        const validateBtn = document.getElementById('validateBtn');
        const importBtn = document.getElementById('importBtn');
        const validateText = document.getElementById('validateText');
        const importText = document.getElementById('importText');
        const alert = document.getElementById('alert');
        const findings = document.getElementById('findings');
        const findingsList = document.getElementById('findingsList');
        const resultsCard = document.getElementById('resultsCard');
        const warningsCard = document.getElementById('warningsCard');
        const warningsContent = document.getElementById('warningsContent');
        const logsCard = document.getElementById('logsCard');
        const logsContent = document.getElementById('logsContent');
        const toggleLogs = document.getElementById('toggleLogs');

        let validationResult = null;
        let logsVisible = false;

        // Toggle logs visibility
        toggleLogs.addEventListener('click', () => {
            logsVisible = !logsVisible;
            logsContent.style.display = logsVisible ? 'block' : 'none';
            toggleLogs.textContent = logsVisible ? 'Hide Details' : 'Show Details';
        });

        // Validate profile name input in real-time
        profileNameInput.addEventListener('input', (e) => {
            let value = e.target.value;
            // Remove invalid characters as user types
            const sanitized = value.replace(/[^a-zA-Z0-9_-]/g, '');
            if (value !== sanitized) {
                e.target.value = sanitized;
            }
        });

        // Show alert message
        function showAlert(message, type = 'info') {
            alert.textContent = message;
            alert.className = `alert alert-${type} show`;
            setTimeout(() => {
                alert.classList.remove('show');
            }, 5000);
        }

        // Validate path
        validateBtn.addEventListener('click', async () => {
            const importPath = importPathInput.value.trim();
            
            if (!importPath) {
                showAlert('Please enter a path', 'error');
                return;
            }

            validateBtn.disabled = true;
            validateText.innerHTML = '<span class="spinner"></span> Validating...';

            try {
                const response = await fetch('/api/config-import/validate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ importPath })
                });

                const data = await response.json();
                validationResult = data;

                if (data.valid) {
                    let successMsg = '‚úÖ Valid configuration path found!';
                    if (data.detectedSubdirectory) {
                        successMsg += ` (Found in ${data.detectedSubdirectory}/ subdirectory)`;
                    }
                    showAlert(successMsg, 'success');
                    importBtn.disabled = false;

                    // Show findings
                    findingsList.innerHTML = '';
                    
                    const items = [
                        { label: 'User Profiles (user_configs)', found: data.findings.userConfigs },
                        { label: 'User Data (user_data)', found: data.findings.userData },
                        { label: 'Uploaded Files (uploads)', found: data.findings.uploads },
                        { label: 'Plugin Data (plugins/*/data)', found: data.findings.plugins },
                        { label: 'Legacy Database (database.db)', found: data.findings.legacyDatabase },
                        { label: 'Legacy Data Folder (data/)', found: data.findings.legacyData }
                    ];

                    items.forEach(item => {
                        const li = document.createElement('li');
                        li.className = item.found ? 'found' : 'not-found';
                        li.textContent = `${item.found ? '‚úÖ' : '‚ùå'} ${item.label}`;
                        findingsList.appendChild(li);
                    });

                    findings.classList.add('show');
                } else {
                    showAlert(`‚ùå ${data.error || 'Invalid path'}`, 'error');
                    importBtn.disabled = true;
                    findings.classList.remove('show');
                }
            } catch (error) {
                showAlert(`Error: ${error.message}`, 'error');
                importBtn.disabled = true;
                findings.classList.remove('show');
            } finally {
                validateBtn.disabled = false;
                validateText.innerHTML = 'üîç Validate Path';
            }
        });

        // Import settings
        importBtn.addEventListener('click', async () => {
            const importPath = importPathInput.value.trim();
            const profileName = profileNameInput.value.trim();
            
            if (!importPath || !validationResult?.valid) {
                showAlert('Please validate the path first', 'error');
                return;
            }

            importBtn.disabled = true;
            importText.innerHTML = '<span class="spinner"></span> Importing...';

            try {
                const response = await fetch('/api/config-import/import', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ importPath, profileName })
                });

                const data = await response.json();

                if (data.success) {
                    // Build detailed success message with profile switching instructions
                    let successMessage = '‚úÖ Settings imported successfully!\n\n';
                    
                    // List what was imported
                    const importedItems = [];
                    if (data.imported.userConfigs > 0) importedItems.push(`${data.imported.userConfigs} user config files`);
                    if (data.imported.userData > 0) importedItems.push(`${data.imported.userData} user data files`);
                    if (data.imported.uploads > 0) importedItems.push(`${data.imported.uploads} uploads`);
                    if (data.imported.plugins > 0) importedItems.push(`${data.imported.plugins} plugin data files`);
                    if (data.imported.legacyDatabase > 0) importedItems.push(`${data.imported.legacyDatabase} legacy database files`);
                    if (data.imported.legacyData > 0) importedItems.push(`${data.imported.legacyData} legacy data files`);
                    
                    if (importedItems.length > 0) {
                        successMessage += 'üì¶ Imported: ' + importedItems.join(', ') + '\n\n';
                    }
                    
                    // Critical: Explain profile switching if user configs or legacy database was imported
                    if (data.imported.userConfigs > 0 || data.imported.legacyDatabase > 0) {
                        successMessage += '‚ö†Ô∏è IMPORTANT - Next Steps:\n';
                        successMessage += '1. Go to Settings ‚Üí User Profiles\n';
                        
                        if (data.profileName && data.profileName !== 'imported-config') {
                            successMessage += `2. Switch to the "${data.profileName}" profile\n`;
                        } else {
                            successMessage += '2. Switch to the imported profile (check for "default" or "imported-config")\n';
                        }
                        
                        successMessage += '3. Restart the application\n\n';
                        successMessage += 'üí° Your imported settings will only be visible after switching to the imported profile!';
                    } else {
                        successMessage += 'Please restart the application to see your imported data.';
                    }
                    
                    showAlert(successMessage, 'success');
                    
                    // Show warnings if any
                    if (data.warnings && data.warnings.length > 0) {
                        warningsContent.innerHTML = '';
                        data.warnings.forEach(warning => {
                            const li = document.createElement('li');
                            li.textContent = warning;
                            li.style.marginBottom = '8px';
                            warningsContent.appendChild(li);
                        });
                        warningsCard.style.display = 'block';
                    } else {
                        warningsCard.style.display = 'none';
                    }

                    // Show logs if any
                    if (data.logs && data.logs.length > 0) {
                        logsContent.innerHTML = '';
                        data.logs.forEach(log => {
                            const logLine = document.createElement('div');
                            logLine.style.marginBottom = '4px';
                            
                            // Color code by level
                            let color = '#888';
                            if (log.level === 'error') color = '#f87171';
                            else if (log.level === 'warn') color = '#fbbf24';
                            else if (log.level === 'info') color = '#60a5fa';
                            else if (log.level === 'debug') color = '#888';
                            
                            const timestamp = new Date(log.timestamp).toLocaleTimeString();
                            
                            // Create safe elements to prevent XSS
                            const levelSpan = document.createElement('span');
                            levelSpan.style.color = color;
                            levelSpan.textContent = `[${timestamp}] [${log.level.toUpperCase()}]`;
                            
                            logLine.appendChild(levelSpan);
                            logLine.appendChild(document.createTextNode(' ' + log.message));
                            logsContent.appendChild(logLine);
                        });
                        logsCard.style.display = 'block';
                        // Auto-expand logs if there are errors or warnings
                        if (data.errors.length > 0 || data.warnings.length > 0) {
                            logsVisible = true;
                            logsContent.style.display = 'block';
                            toggleLogs.textContent = 'Hide Details';
                        }
                    } else {
                        logsCard.style.display = 'none';
                    }
                    
                    // Show results
                    document.getElementById('userConfigsCount').textContent = data.imported.userConfigs;
                    document.getElementById('userDataCount').textContent = data.imported.userData;
                    document.getElementById('uploadsCount').textContent = data.imported.uploads;
                    
                    // Show plugin results if any were imported
                    const pluginsCard = document.getElementById('pluginsCard');
                    if (data.imported.plugins > 0) {
                        document.getElementById('pluginsCount').textContent = data.imported.plugins;
                        pluginsCard.style.display = 'block';
                    } else {
                        pluginsCard.style.display = 'none';
                    }
                    
                    // Show legacy results if any were imported
                    const legacyDbCard = document.getElementById('legacyDbCard');
                    const legacyDataCard = document.getElementById('legacyDataCard');
                    
                    if (data.imported.legacyDatabase > 0) {
                        document.getElementById('legacyDatabaseCount').textContent = data.imported.legacyDatabase;
                        legacyDbCard.style.display = 'block';
                    } else {
                        legacyDbCard.style.display = 'none';
                    }
                    
                    if (data.imported.legacyData > 0) {
                        document.getElementById('legacyDataCount').textContent = data.imported.legacyData;
                        legacyDataCard.style.display = 'block';
                    } else {
                        legacyDataCard.style.display = 'none';
                    }
                    
                    resultsCard.style.display = 'block';
                    
                    // Show profile switching reminder if profiles were imported
                    const profileSwitchReminder = document.getElementById('profileSwitchReminder');
                    const importedProfileNameSpan = document.getElementById('importedProfileName');
                    
                    if (data.imported.userConfigs > 0 || data.imported.legacyDatabase > 0) {
                        // Determine which profile name to show
                        let profileToShow = 'default';
                        if (data.profileName && data.profileName !== 'imported-config') {
                            profileToShow = data.profileName;
                        } else {
                            // Try to determine from the logs if available
                            // Look for successful import messages with the actual destination path
                            const successLog = data.logs?.find(log => 
                                log.message.includes('Successfully imported') && 
                                log.message.includes('.db to') &&
                                log.message.includes('user_configs')
                            );
                            if (successLog) {
                                // Extract filename from path like "...user_configs\default.db (1 files)"
                                const match = successLog.message.match(/user_configs[\\\/]([\w-]+)\.db/);
                                if (match) profileToShow = match[1];
                            } else {
                                // Fallback: look for "Importing database file:" message
                                const dbImportLog = data.logs?.find(log => 
                                    log.message.includes('Importing database file:') && 
                                    log.message.includes('.db')
                                );
                                if (dbImportLog) {
                                    const match = dbImportLog.message.match(/Importing database file: ([\w-]+)\.db/);
                                    if (match) profileToShow = match[1];
                                }
                            }
                        }
                        
                        importedProfileNameSpan.textContent = profileToShow;
                        profileSwitchReminder.style.display = 'block';
                    } else {
                        profileSwitchReminder.style.display = 'none';
                    }

                    // Scroll to results
                    resultsCard.scrollIntoView({ behavior: 'smooth' });

                    // Clear form
                    importPathInput.value = '';
                    findings.classList.remove('show');
                    validationResult = null;
                } else {
                    const errorMsg = data.errors?.join(', ') || data.error || 'Import failed';
                    showAlert(`‚ùå ${errorMsg}`, 'error');
                }
            } catch (error) {
                showAlert(`Error: ${error.message}`, 'error');
            } finally {
                importBtn.disabled = false;
                importText.innerHTML = 'üì• Import Settings';
            }
        });

        // Enable import button on Enter key in path input
        importPathInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                validateBtn.click();
            }
        });
    </script>
</body>
</html>
