<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <!-- Fixed viewport for OBS Browser Source - standard 1080p overlay dimensions -->
    <meta name="viewport" content="width=1920, height=1080">
    <title>StreamAlchemy Overlay</title>
    <link rel="stylesheet" href="/streamalchemy/style.css">
</head>
<body>
    <!-- Discovery Popup (New Item First Time) -->
    <div id="discoveryPopup" class="discovery-popup hidden">
        <div class="discovery-content">
            <div class="discovery-glow"></div>
            <div class="discovery-particles"></div>
            <img id="discoveryImage" class="discovery-image" src="" alt="Item">
            <h2 id="discoveryTitle" class="discovery-title">Congratulations!</h2>
            <p id="discoveryText" class="discovery-text">You have alchemized</p>
            <h3 id="discoveryItemName" class="discovery-item-name"></h3>
            <p id="discoveryRarity" class="discovery-rarity"></p>
        </div>
    </div>

    <!-- Crafting Animation Container -->
    <div id="craftingContainer" class="crafting-container hidden">
        <div class="crafting-content">
            <!-- Left Item -->
            <div class="crafting-item crafting-item-left">
                <img id="craftingItemA" src="" alt="Item A">
                <p id="craftingNameA"></p>
            </div>

            <!-- Center Fusion Effect -->
            <div class="crafting-fusion">
                <div class="fusion-circle"></div>
                <div class="fusion-spark"></div>
                <div class="fusion-spark"></div>
                <div class="fusion-spark"></div>
                <div class="fusion-ring"></div>
            </div>

            <!-- Right Item -->
            <div class="crafting-item crafting-item-right">
                <img id="craftingItemB" src="" alt="Item B">
                <p id="craftingNameB"></p>
            </div>

            <!-- Status Text -->
            <div class="crafting-status">
                <p id="craftingStatusText">Crafting in progress...</p>
            </div>
        </div>
    </div>

    <!-- Corner Counter (Repeat Items) -->
    <div id="cornerCounter" class="corner-counter hidden">
        <div class="counter-content">
            <img id="counterImage" src="" alt="Item">
            <div class="counter-info">
                <p id="counterItemName"></p>
                <p id="counterQuantity" class="counter-quantity">+1</p>
            </div>
        </div>
    </div>

    <!-- Socket.io Client -->
    <script src="/socket.io/socket.io.js"></script>
    
    <script>
        // ===== SOCKET.IO CONNECTION =====
        const socket = io();
        
        // ===== STATE =====
        let isAnimating = false;
        let animationQueue = [];

        // ===== UTILITY FUNCTIONS =====
        
        /**
         * Show discovery popup for new items
         */
        function showDiscoveryPopup(item) {
            const popup = document.getElementById('discoveryPopup');
            const image = document.getElementById('discoveryImage');
            const itemName = document.getElementById('discoveryItemName');
            const rarity = document.getElementById('discoveryRarity');
            
            // Set content
            image.src = item.imageURL || '/assets/placeholder-item.png';
            itemName.textContent = item.name;
            rarity.textContent = item.rarity;
            
            // Set rarity class
            popup.className = 'discovery-popup';
            popup.classList.add(`rarity-${item.rarity.toLowerCase()}`);
            
            // Show popup
            popup.classList.remove('hidden');
            popup.classList.add('animate-in');
            
            // Generate particles
            generateParticles(document.querySelector('.discovery-particles'), item.rarity);
            
            // Hide after duration
            setTimeout(() => {
                popup.classList.remove('animate-in');
                popup.classList.add('animate-out');
                
                setTimeout(() => {
                    popup.classList.add('hidden');
                    popup.classList.remove('animate-out');
                    isAnimating = false;
                    processQueue();
                }, 1000);
            }, 5000);
        }

        /**
         * Show crafting animation
         */
        function showCraftingAnimation(itemA, itemB) {
            const container = document.getElementById('craftingContainer');
            const imgA = document.getElementById('craftingItemA');
            const imgB = document.getElementById('craftingItemB');
            const nameA = document.getElementById('craftingNameA');
            const nameB = document.getElementById('craftingNameB');
            
            // Set content
            imgA.src = itemA.imageURL || '/assets/placeholder-item.png';
            imgB.src = itemB.imageURL || '/assets/placeholder-item.png';
            nameA.textContent = itemA.name;
            nameB.textContent = itemB.name;
            
            // Show container
            container.classList.remove('hidden');
            container.classList.add('animate-crafting');
        }

        /**
         * Complete crafting animation with result
         */
        function completeCraftingAnimation(craftedItem) {
            const container = document.getElementById('craftingContainer');
            
            // Wait for fusion animation
            setTimeout(() => {
                // Hide crafting container
                container.classList.remove('animate-crafting');
                container.classList.add('animate-out');
                
                setTimeout(() => {
                    container.classList.add('hidden');
                    container.classList.remove('animate-out');
                    
                    // Show discovery popup for crafted item
                    showDiscoveryPopup(craftedItem);
                }, 1000);
            }, 3000);
        }

        /**
         * Show corner counter for repeat items
         */
        function showCornerCounter(item, quantity) {
            const counter = document.getElementById('cornerCounter');
            const image = document.getElementById('counterImage');
            const itemName = document.getElementById('counterItemName');
            const quantityText = document.getElementById('counterQuantity');
            
            // Set content
            image.src = item.imageURL || '/assets/placeholder-item.png';
            itemName.textContent = item.name;
            quantityText.textContent = `+1 (Total: ${quantity})`;
            
            // Set rarity class
            counter.className = 'corner-counter';
            counter.classList.add(`rarity-${item.rarity.toLowerCase()}`);
            
            // Show counter
            counter.classList.remove('hidden');
            counter.classList.add('bounce-in');
            
            // Hide after duration
            setTimeout(() => {
                counter.classList.remove('bounce-in');
                counter.classList.add('fade-out');
                
                setTimeout(() => {
                    counter.classList.add('hidden');
                    counter.classList.remove('fade-out');
                }, 500);
            }, 3000);
        }

        /**
         * Generate particle effects based on rarity
         */
        function generateParticles(container, rarity) {
            container.innerHTML = '';
            
            const rarityColors = {
                'Common': '#CD7F32',
                'Rare': '#C0C0C0',
                'Legendary': '#FFD700',
                'Mythic': '#9370DB'
            };
            
            const color = rarityColors[rarity] || rarityColors['Common'];
            const particleCount = rarity === 'Mythic' ? 30 : rarity === 'Legendary' ? 20 : 15;
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.setProperty('--color', color);
                particle.style.setProperty('--x', Math.random() * 200 - 100 + 'px');
                particle.style.setProperty('--y', Math.random() * 200 - 100 + 'px');
                particle.style.setProperty('--delay', Math.random() * 2 + 's');
                particle.style.setProperty('--duration', Math.random() * 2 + 1 + 's');
                container.appendChild(particle);
            }
        }

        /**
         * Process animation queue
         */
        function processQueue() {
            if (isAnimating || animationQueue.length === 0) return;
            
            isAnimating = true;
            const nextAnimation = animationQueue.shift();
            nextAnimation();
        }

        /**
         * Queue an animation
         */
        function queueAnimation(animationFn) {
            animationQueue.push(animationFn);
            if (!isAnimating) {
                processQueue();
            }
        }

        // ===== SOCKET EVENT HANDLERS =====

        /**
         * Handle item discovery (first time)
         */
        socket.on('streamalchemy:item_discovery', (data) => {
            console.log('Item discovery:', data);
            queueAnimation(() => {
                showDiscoveryPopup(data.item);
            });
        });

        /**
         * Handle item increment (repeat)
         */
        socket.on('streamalchemy:item_increment', (data) => {
            console.log('Item increment:', data);
            showCornerCounter(data.item, data.quantity);
        });

        /**
         * Handle crafting start
         */
        socket.on('streamalchemy:crafting_start', (data) => {
            console.log('Crafting start:', data);
            queueAnimation(() => {
                isAnimating = true;
                showCraftingAnimation(data.itemA, data.itemB);
            });
        });

        /**
         * Handle crafting complete
         */
        socket.on('streamalchemy:crafting_complete', (data) => {
            console.log('Crafting complete:', data);
            completeCraftingAnimation(data.craftedItem);
        });

        /**
         * Connection status
         */
        socket.on('connect', () => {
            console.log('Connected to StreamAlchemy');
        });

        socket.on('disconnect', () => {
            console.log('Disconnected from StreamAlchemy');
        });

        // ===== INITIALIZATION =====
        console.log('StreamAlchemy Overlay loaded');
    </script>
</body>
</html>
