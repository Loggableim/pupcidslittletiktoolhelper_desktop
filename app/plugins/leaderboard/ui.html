<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaderboard - Configuration</title>
    <link rel="stylesheet" href="/css/themes.css">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--color-bg-primary);
            color: var(--color-text-primary);
            padding: 32px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            margin-bottom: 32px;
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        .header p {
            color: var(--color-text-secondary);
            font-size: 1rem;
        }

        .card {
            background: var(--color-bg-card);
            border: 1px solid var(--color-border);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            padding: 16px;
        }

        .stat-label {
            color: var(--color-text-secondary);
            font-size: 0.875rem;
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--color-accent-primary);
        }

        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
        }

        .leaderboard-table th,
        .leaderboard-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--color-border);
        }

        .leaderboard-table th {
            background: var(--color-bg-secondary);
            font-weight: 600;
        }

        .leaderboard-table tr:hover {
            background: var(--color-bg-secondary);
        }

        .rank-badge {
            display: inline-block;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            text-align: center;
            line-height: 32px;
            font-weight: 700;
        }

        .rank-1 { background: gold; color: #000; }
        .rank-2 { background: silver; color: #000; }
        .rank-3 { background: #cd7f32; color: #000; }
        .rank-other { background: var(--color-bg-tertiary); }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--color-accent-primary);
            color: white;
        }

        .btn-primary:hover {
            filter: brightness(1.1);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--color-bg-secondary);
            color: var(--color-text-primary);
            border: 1px solid var(--color-border);
        }

        .btn-secondary:hover {
            background: var(--color-bg-tertiary);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--color-text-primary);
        }

        .form-label input[type="checkbox"] {
            margin-right: 8px;
            width: auto;
        }

        .form-input, select.form-input {
            width: 100%;
            padding: 10px 12px;
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            color: var(--color-text-primary);
            font-size: 0.875rem;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--color-accent-primary);
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            border-bottom: 2px solid var(--color-border);
        }

        .tab-btn {
            padding: 12px 24px;
            background: none;
            border: none;
            color: var(--color-text-secondary);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            position: relative;
        }

        .tab-btn:hover {
            color: var(--color-text-primary);
        }

        .tab-btn.active {
            color: var(--color-accent-primary);
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--color-accent-primary);
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        .message {
            padding: 12px;
            margin-bottom: 16px;
            border-radius: 8px;
        }

        .message.success {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: #10b981;
        }

        .message.error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--color-text-secondary);
        }

        .empty-icon {
            font-size: 4rem;
            margin-bottom: 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèÜ Leaderboard Configuration</h1>
            <p>Manage and display top gifters on your stream</p>
        </div>

        <div id="message-container"></div>

        <!-- Statistics -->
        <div class="card">
            <div class="card-title">üìä Statistics</div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Session Gifters</div>
                    <div class="stat-value" id="stat-session-gifters">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">All-Time Gifters</div>
                    <div class="stat-value" id="stat-alltime-gifters">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Session Total Coins</div>
                    <div class="stat-value" id="stat-session-coins">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">All-Time Total Coins</div>
                    <div class="stat-value" id="stat-alltime-coins">0</div>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab-btn active" data-tab="session">Current Session</button>
            <button class="tab-btn" data-tab="alltime">All-Time</button>
            <button class="tab-btn" data-tab="settings">Settings</button>
        </div>

        <!-- Session Tab -->
        <div class="tab-panel active" id="session-tab">
            <div class="card">
                <div class="card-title">
                    üî• Current Session Leaderboard
                    <div style="margin-left: auto;">
                        <button class="btn btn-secondary" id="reset-session-btn">Reset Session</button>
                    </div>
                </div>
                <div id="session-start-info" style="margin-bottom: 16px; color: var(--color-text-secondary);"></div>
                <table class="leaderboard-table">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>User</th>
                            <th>Coins</th>
                            <th>Gifts Count</th>
                        </tr>
                    </thead>
                    <tbody id="session-leaderboard">
                        <tr>
                            <td colspan="4" class="empty-state">
                                <div class="empty-icon">üéÅ</div>
                                <p>Waiting for gifts in this session...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- All-Time Tab -->
        <div class="tab-panel" id="alltime-tab">
            <div class="card">
                <div class="card-title">üëë All-Time Champions</div>
                <table class="leaderboard-table">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>User</th>
                            <th>Total Coins</th>
                            <th>Total Gifts</th>
                        </tr>
                    </thead>
                    <tbody id="alltime-leaderboard">
                        <tr>
                            <td colspan="4" class="empty-state">
                                <div class="empty-icon">üèÜ</div>
                                <p>No champions yet...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Settings Tab -->
        <div class="tab-panel" id="settings-tab">
            <div class="card">
                <div class="card-title">‚öôÔ∏è Leaderboard Settings</div>
                <form id="config-form">
                    <div class="form-group">
                        <label class="form-label" for="display-limit">Display Limit</label>
                        <input type="number" class="form-input" id="display-limit" name="displayLimit" min="1" max="50" value="10">
                        <small style="color: var(--color-text-secondary);">Number of top users to display on overlay</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="min-coins">Minimum Coins</label>
                        <input type="number" class="form-input" id="min-coins" name="minCoins" min="0" value="0">
                        <small style="color: var(--color-text-secondary);">Minimum coins required to appear on leaderboard</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="theme-select">Overlay Theme</label>
                        <select class="form-input" id="theme-select" name="theme">
                            <option value="neon">Neon/Cyberpunk (Cyan & Magenta)</option>
                            <option value="elegant">Elegant/Minimalist (Clean White)</option>
                            <option value="gaming">Gaming/Esports (Red & Orange)</option>
                            <option value="royal">Royal/Crown (Purple & Gold)</option>
                            <option value="gradient">Modern Gradient (Blue & Teal)</option>
                        </select>
                        <small style="color: var(--color-text-secondary);">Choose the visual style for your overlay</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" id="show-animations" name="showAnimations" checked>
                            Enable Overtake Animations
                        </label>
                        <small style="color: var(--color-text-secondary);">Show special effects when someone moves up in rank</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Overlay URL</label>
                        <input type="text" class="form-input" id="overlay-url" readonly>
                        <small style="color: var(--color-text-secondary);">Use this URL in OBS Browser Source</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Preview URL (Test Mode with Mock Data)</label>
                        <input type="text" class="form-input" id="preview-url" readonly>
                        <small style="color: var(--color-text-secondary);">Use this URL to preview different themes with test data</small>
                    </div>

                    <div style="display: flex; gap: 10px;">
                        <button type="submit" class="btn btn-primary">Save Settings</button>
                        <button type="button" class="btn btn-secondary" id="preview-btn">Preview Overlay</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let config = {};
        let sessionData = [];
        let alltimeData = [];

        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tab = btn.dataset.tab;
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(`${tab}-tab`).classList.add('active');
            });
        });

        // Load configuration
        async function loadConfig() {
            try {
                const response = await fetch('/api/plugins/leaderboard/config');
                const data = await response.json();
                if (data.success) {
                    config = data.config;
                    updateConfigForm();
                }
            } catch (error) {
                console.error('Failed to load config:', error);
            }
        }

        // Load leaderboards
        async function loadLeaderboards() {
            try {
                const response = await fetch('/api/plugins/leaderboard/combined?limit=50');
                const data = await response.json();
                
                if (data.success) {
                    sessionData = data.session.data || [];
                    alltimeData = data.alltime.data || [];
                    
                    updateSessionLeaderboard();
                    updateAlltimeLeaderboard();
                    updateStats();
                    
                    if (data.session.startTime) {
                        const startDate = new Date(data.session.startTime);
                        document.getElementById('session-start-info').textContent = 
                            `Session started: ${startDate.toLocaleString()}`;
                    }
                }
            } catch (error) {
                console.error('Failed to load leaderboards:', error);
            }
        }

        // Update session leaderboard
        function updateSessionLeaderboard() {
            const tbody = document.getElementById('session-leaderboard');
            
            if (!sessionData || sessionData.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" class="empty-state">
                    <div class="empty-icon">üéÅ</div>
                    <p>Waiting for gifts in this session...</p>
                </td></tr>`;
                return;
            }

            tbody.innerHTML = sessionData.map((user, index) => `
                <tr>
                    <td><span class="rank-badge ${getRankClass(index + 1)}">${index + 1}</span></td>
                    <td>${user.nickname || user.uniqueId}</td>
                    <td>${user.coins.toLocaleString()}</td>
                    <td>${user.giftCount || 0}</td>
                </tr>
            `).join('');
        }

        // Update all-time leaderboard
        function updateAlltimeLeaderboard() {
            const tbody = document.getElementById('alltime-leaderboard');
            
            if (!alltimeData || alltimeData.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" class="empty-state">
                    <div class="empty-icon">üèÜ</div>
                    <p>No champions yet...</p>
                </td></tr>`;
                return;
            }

            tbody.innerHTML = alltimeData.map((user, index) => `
                <tr>
                    <td><span class="rank-badge ${getRankClass(index + 1)}">${index + 1}</span></td>
                    <td>${user.nickname || user.uniqueId}</td>
                    <td>${user.totalCoins.toLocaleString()}</td>
                    <td>${user.totalGifts || 0}</td>
                </tr>
            `).join('');
        }

        // Update statistics
        function updateStats() {
            const sessionCoins = sessionData.reduce((sum, u) => sum + u.coins, 0);
            const alltimeCoins = alltimeData.reduce((sum, u) => sum + u.totalCoins, 0);
            
            document.getElementById('stat-session-gifters').textContent = sessionData.length;
            document.getElementById('stat-alltime-gifters').textContent = alltimeData.length;
            document.getElementById('stat-session-coins').textContent = sessionCoins.toLocaleString();
            document.getElementById('stat-alltime-coins').textContent = alltimeCoins.toLocaleString();
        }

        // Get rank class for styling
        function getRankClass(rank) {
            if (rank === 1) return 'rank-1';
            if (rank === 2) return 'rank-2';
            if (rank === 3) return 'rank-3';
            return 'rank-other';
        }

        // Update config form
        function updateConfigForm() {
            document.getElementById('display-limit').value = config.displayLimit || config.top_count || 10;
            document.getElementById('min-coins').value = config.minCoins || config.min_coins_to_show || 0;
            document.getElementById('theme-select').value = config.theme || 'neon';
            document.getElementById('show-animations').checked = config.showAnimations !== undefined ? config.showAnimations : (config.show_animations !== 0);
            
            // Set overlay URL dynamically
            const overlayUrl = `${window.location.protocol}//${window.location.host}/leaderboard/overlay`;
            document.getElementById('overlay-url').value = overlayUrl;
            
            // Set preview URL
            const previewUrl = `${window.location.protocol}//${window.location.host}/leaderboard/overlay?preview=true&theme=${config.theme || 'neon'}`;
            document.getElementById('preview-url').value = previewUrl;
        }

        // Handle form submission
        document.getElementById('config-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const newConfig = {
                displayLimit: parseInt(formData.get('displayLimit')),
                minCoins: parseInt(formData.get('minCoins')),
                top_count: parseInt(formData.get('displayLimit')),
                min_coins_to_show: parseInt(formData.get('minCoins')),
                theme: formData.get('theme'),
                showAnimations: document.getElementById('show-animations').checked,
                show_animations: document.getElementById('show-animations').checked ? 1 : 0
            };

            try {
                const response = await fetch('/api/plugins/leaderboard/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(newConfig)
                });

                const data = await response.json();
                if (data.success) {
                    showMessage('Configuration saved successfully!', 'success');
                    config = newConfig;
                    updateConfigForm();
                } else {
                    showMessage('Failed to save configuration', 'error');
                }
            } catch (error) {
                console.error('Failed to save config:', error);
                showMessage('Failed to save configuration', 'error');
            }
        });

        // Preview button handler
        document.getElementById('preview-btn').addEventListener('click', () => {
            const theme = document.getElementById('theme-select').value;
            const previewUrl = `${window.location.protocol}//${window.location.host}/leaderboard/overlay?preview=true&theme=${theme}`;
            window.open(previewUrl, '_blank', 'width=500,height=850');
        });

        // Reset session
        document.getElementById('reset-session-btn').addEventListener('click', async () => {
            if (!confirm('Are you sure you want to reset the current session? This cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch('/api/plugins/leaderboard/reset-session', {
                    method: 'POST'
                });

                const data = await response.json();
                if (data.success) {
                    showMessage('Session reset successfully!', 'success');
                    loadLeaderboards();
                } else {
                    showMessage('Failed to reset session', 'error');
                }
            } catch (error) {
                console.error('Failed to reset session:', error);
                showMessage('Failed to reset session', 'error');
            }
        });

        // Show message
        function showMessage(text, type) {
            const container = document.getElementById('message-container');
            const message = document.createElement('div');
            message.className = `message ${type}`;
            message.textContent = text;
            container.appendChild(message);
            
            setTimeout(() => message.remove(), 5000);
        }

        // Socket.io events
        socket.on('leaderboard:update', (data) => {
            if (data.session) {
                sessionData = data.session.data || [];
                updateSessionLeaderboard();
            }
            if (data.alltime) {
                alltimeData = data.alltime.data || [];
                updateAlltimeLeaderboard();
            }
            updateStats();
        });

        // Initialize
        loadConfig();
        loadLeaderboards();

        // Refresh every 10 seconds
        setInterval(loadLeaderboards, 10000);
    </script>
</body>
</html>
