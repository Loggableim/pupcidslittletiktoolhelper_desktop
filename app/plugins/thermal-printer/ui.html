<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thermal Printer - Configuration</title>
    <link rel="stylesheet" href="/css/themes.css">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background: var(--color-bg-primary);
            color: var(--color-text-primary);
            padding: 2rem 1.5rem;
            min-height: 100vh;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: var(--color-bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--color-border);
        }

        .header h1 {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--color-text-primary);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .card {
            background: var(--color-bg-card);
            border: 1px solid var(--color-border);
            border-radius: 12px;
            margin-bottom: 1.5rem;
            overflow: hidden;
        }

        .card-header {
            background: var(--color-bg-secondary);
            border-bottom: 1px solid var(--color-border);
            padding: 1rem 1.5rem;
        }

        .card-header h5 {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--color-text-primary);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-body {
            padding: 1.5rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .stats-box {
            background: var(--color-bg-tertiary);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid var(--color-border);
        }

        .stats-label {
            color: var(--color-text-muted);
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }

        .stats-value {
            color: var(--color-text-primary);
            font-size: 1.5rem;
            font-weight: 700;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .badge-success {
            background: var(--color-accent-success);
            color: white;
        }

        .badge-warning {
            background: var(--color-accent-warning);
            color: white;
        }

        .badge-danger {
            background: var(--color-accent-danger);
            color: white;
        }

        .badge-secondary {
            background: var(--color-bg-tertiary);
            color: var(--color-text-secondary);
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            font-weight: 600;
            color: var(--color-text-primary);
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .form-control,
        .form-select {
            width: 100%;
            padding: 0.625rem 0.875rem;
            background: var(--color-input-bg);
            border: 1px solid var(--color-input-border);
            border-radius: 8px;
            color: var(--color-input-text);
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .form-control:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--color-input-focus);
            box-shadow: 0 0 0 3px var(--color-active-bg);
        }

        .form-control::placeholder {
            color: var(--color-input-placeholder);
        }

        .form-text {
            display: block;
            margin-top: 0.375rem;
            font-size: 0.75rem;
            color: var(--color-text-muted);
        }

        .form-check {
            display: flex;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .form-check-input {
            width: 1.125rem;
            height: 1.125rem;
            margin-right: 0.625rem;
            cursor: pointer;
            accent-color: var(--color-accent-primary);
        }

        .form-check-label {
            color: var(--color-text-primary);
            cursor: pointer;
            font-size: 0.875rem;
        }

        .form-switch .form-check-input {
            width: 2.5rem;
            height: 1.25rem;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='3' fill='rgba%28255,255,255,1%29'/%3e%3c/svg%3e");
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.625rem 1.25rem;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--color-accent-primary);
            color: white;
        }

        .btn-primary:hover {
            filter: brightness(1.1);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-success {
            background: var(--color-accent-success);
            color: white;
        }

        .btn-success:hover {
            filter: brightness(1.1);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background: var(--color-btn-secondary-bg);
            color: var(--color-btn-secondary-text);
        }

        .btn-secondary:hover {
            background: var(--color-btn-secondary-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .section-divider {
            border: none;
            border-top: 1px solid var(--color-border);
            margin: 1.5rem 0;
        }

        .section-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            color: var(--color-text-primary);
            margin-bottom: 1rem;
        }

        .button-group {
            display: flex;
            justify-content: space-between;
            gap: 1rem;
            margin-top: 2rem;
        }

        /* Icons using simple unicode symbols */
        .icon-printer::before { content: "üñ®Ô∏è "; }
        .icon-activity::before { content: "üìä "; }
        .icon-settings::before { content: "‚öôÔ∏è "; }
        .icon-plug::before { content: "üîå "; }
        .icon-filter::before { content: "üîç "; }
        .icon-format::before { content: "üìù "; }
        .icon-sliders::before { content: "üéöÔ∏è "; }
        .icon-save::before { content: "üíæ "; }
        .icon-test::before { content: "‚ñ∂Ô∏è "; }
        .icon-back::before { content: "‚Üê "; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1><span class="icon-printer"></span>Thermal Printer Configuration</h1>
            <a href="/" class="btn btn-secondary">
                <span class="icon-back"></span>Back to Dashboard
            </a>
        </div>

        <!-- Status Card -->
        <div class="card">
            <div class="card-header">
                <h5><span class="icon-activity"></span>Status</h5>
            </div>
            <div class="card-body">
                <div class="stats-grid">
                    <div class="stats-box">
                        <div class="stats-label">Connection Status</div>
                        <div class="stats-value" id="connection-status">
                            <span class="status-badge badge-secondary">Loading...</span>
                        </div>
                    </div>
                    <div class="stats-box">
                        <div class="stats-label">Queue Size</div>
                        <div class="stats-value" id="queue-size">0</div>
                    </div>
                </div>
                <div class="stats-grid">
                    <div class="stats-box">
                        <div class="stats-label">Printed Jobs</div>
                        <div class="stats-value" id="printed-jobs">0</div>
                    </div>
                    <div class="stats-box">
                        <div class="stats-label">Failed Jobs</div>
                        <div class="stats-value" id="failed-jobs">0</div>
                    </div>
                    <div class="stats-box">
                        <div class="stats-label">Uptime</div>
                        <div class="stats-value" id="uptime">0s</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Configuration Form -->
        <div class="card">
            <div class="card-header">
                <h5><span class="icon-settings"></span>Configuration</h5>
            </div>
            <div class="card-body">
                <form id="config-form">
                    <!-- Enable/Disable -->
                    <div class="form-group">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="enabled">
                            <label class="form-check-label" for="enabled">
                                <strong>Enable Thermal Printer</strong>
                            </label>
                        </div>
                    </div>

                    <hr class="section-divider">

                    <!-- Printer Connection -->
                    <h6 class="section-title"><span class="icon-plug"></span>Printer Connection</h6>
                    
                    <div class="form-group">
                        <label for="printerType" class="form-label">Printer Type</label>
                        <select class="form-select" id="printerType">
                            <option value="usb">USB</option>
                            <option value="network">Network</option>
                        </select>
                    </div>

                    <!-- USB Settings -->
                    <div id="usb-settings">
                        <div class="form-group">
                            <label for="usbVendorId" class="form-label">USB Vendor ID</label>
                            <input type="text" class="form-control" id="usbVendorId" placeholder="0x04b8">
                            <small class="form-text">e.g., 0x04b8 for Epson (leave empty for auto-detect)</small>
                        </div>
                        <div class="form-group">
                            <label for="usbProductId" class="form-label">USB Product ID</label>
                            <input type="text" class="form-control" id="usbProductId" placeholder="0x0e15">
                            <small class="form-text">e.g., 0x0e15 for TM-T20 (leave empty for auto-detect)</small>
                        </div>
                    </div>

                    <!-- Network Settings -->
                    <div id="network-settings" style="display: none;">
                        <div class="form-group">
                            <label for="networkHost" class="form-label">Network Host/IP</label>
                            <input type="text" class="form-control" id="networkHost" placeholder="192.168.1.100">
                        </div>
                        <div class="form-group">
                            <label for="networkPort" class="form-label">Network Port</label>
                            <input type="number" class="form-control" id="networkPort" placeholder="9100" min="1" max="65535">
                        </div>
                    </div>

                    <hr class="section-divider">

                    <!-- Event Filters -->
                    <h6 class="section-title"><span class="icon-filter"></span>Event Filters</h6>
                    
                    <div class="form-group">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="printChats">
                            <label class="form-check-label" for="printChats">Print Chat Messages</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="printGifts">
                            <label class="form-check-label" for="printGifts">Print Gifts</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="printFollows">
                            <label class="form-check-label" for="printFollows">Print Follows</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="printShares">
                            <label class="form-check-label" for="printShares">Print Shares</label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="minCoinsToPrint" class="form-label">Minimum Coins to Print (Gifts)</label>
                        <input type="number" class="form-control" id="minCoinsToPrint" min="0">
                        <small class="form-text">Only print gifts with at least this many coins (saves paper)</small>
                    </div>

                    <div class="form-group">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="ignoreBotCommands">
                            <label class="form-check-label" for="ignoreBotCommands">
                                Ignore Bot Commands (messages starting with '!')
                            </label>
                        </div>
                    </div>

                    <hr class="section-divider">

                    <!-- Formatting -->
                    <h6 class="section-title"><span class="icon-format"></span>Formatting</h6>
                    
                    <div class="form-group">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="autoCutPaper">
                            <label class="form-check-label" for="autoCutPaper">Auto-cut paper after each event</label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="width" class="form-label">Paper Width (characters)</label>
                        <input type="number" class="form-control" id="width" min="32" max="80">
                        <small class="form-text">Typical: 48 for 80mm paper, 32 for 58mm paper</small>
                    </div>

                    <div class="form-group">
                        <label for="encoding" class="form-label">Character Encoding</label>
                        <select class="form-select" id="encoding">
                            <option value="GB18030">GB18030 (Default)</option>
                            <option value="UTF-8">UTF-8</option>
                            <option value="ASCII">ASCII</option>
                        </select>
                    </div>

                    <hr class="section-divider">

                    <!-- Advanced Settings -->
                    <h6 class="section-title"><span class="icon-sliders"></span>Advanced Settings</h6>
                    
                    <div class="form-group">
                        <label for="reconnectAttempts" class="form-label">Reconnect Attempts</label>
                        <input type="number" class="form-control" id="reconnectAttempts" min="0">
                    </div>

                    <div class="form-group">
                        <label for="reconnectDelay" class="form-label">Reconnect Delay (ms)</label>
                        <input type="number" class="form-control" id="reconnectDelay" min="0">
                    </div>

                    <div class="form-group">
                        <label for="queueMaxSize" class="form-label">Max Queue Size</label>
                        <input type="number" class="form-control" id="queueMaxSize" min="1">
                    </div>

                    <div class="form-group">
                        <label for="printDelay" class="form-label">Print Delay (ms)</label>
                        <input type="number" class="form-control" id="printDelay" min="0">
                        <small class="form-text">Delay between print jobs (prevents overloading)</small>
                    </div>

                    <!-- Buttons -->
                    <div class="button-group">
                        <button type="button" class="btn btn-success" id="test-print-btn">
                            <span class="icon-test"></span>Test Print
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <span class="icon-save"></span>Save Configuration
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        const socket = io();

        // Load Configuration
        async function loadConfig() {
            try {
                const response = await fetch('/api/thermal-printer/config');
                const data = await response.json();
                
                if (data.success) {
                    populateForm(data.config);
                }
            } catch (error) {
                console.error('Error loading config:', error);
            }
        }

        // Load Status
        async function loadStatus() {
            try {
                const response = await fetch('/api/thermal-printer/status');
                const data = await response.json();
                
                if (data.success) {
                    updateStatus(data.status);
                }
            } catch (error) {
                console.error('Error loading status:', error);
            }
        }

        // Populate Form
        function populateForm(config) {
            document.getElementById('enabled').checked = config.enabled;
            document.getElementById('printerType').value = config.printerType;
            document.getElementById('usbVendorId').value = config.usbVendorId || '';
            document.getElementById('usbProductId').value = config.usbProductId || '';
            document.getElementById('networkHost').value = config.networkHost;
            document.getElementById('networkPort').value = config.networkPort;
            document.getElementById('printChats').checked = config.printChats;
            document.getElementById('printGifts').checked = config.printGifts;
            document.getElementById('printFollows').checked = config.printFollows;
            document.getElementById('printShares').checked = config.printShares;
            document.getElementById('minCoinsToPrint').value = config.minCoinsToPrint;
            document.getElementById('ignoreBotCommands').checked = config.ignoreBotCommands;
            document.getElementById('autoCutPaper').checked = config.autoCutPaper;
            document.getElementById('width').value = config.width;
            document.getElementById('encoding').value = config.encoding;
            document.getElementById('reconnectAttempts').value = config.reconnectAttempts;
            document.getElementById('reconnectDelay').value = config.reconnectDelay;
            document.getElementById('queueMaxSize').value = config.queueMaxSize;
            document.getElementById('printDelay').value = config.printDelay;
            
            togglePrinterSettings();
        }

        // Update Status Display
        function updateStatus(status) {
            // Connection Status
            const statusEl = document.getElementById('connection-status');
            if (status.isConnected) {
                statusEl.innerHTML = '<span class="status-badge badge-success">Connected</span>';
            } else if (status.isReconnecting) {
                statusEl.innerHTML = '<span class="status-badge badge-warning">Reconnecting...</span>';
            } else {
                statusEl.innerHTML = '<span class="status-badge badge-danger">Disconnected</span>';
            }
            
            // Queue Size
            document.getElementById('queue-size').textContent = status.queueSize || 0;
            
            // Stats
            if (status.stats) {
                document.getElementById('printed-jobs').textContent = status.stats.printedJobs || 0;
                document.getElementById('failed-jobs').textContent = status.stats.failedJobs || 0;
                
                const uptime = status.stats.uptime || 0;
                const uptimeStr = formatUptime(uptime);
                document.getElementById('uptime').textContent = uptimeStr;
            }
        }

        // Format Uptime
        function formatUptime(ms) {
            const seconds = Math.floor(ms / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            
            if (hours > 0) {
                return `${hours}h ${minutes % 60}m`;
            } else if (minutes > 0) {
                return `${minutes}m ${seconds % 60}s`;
            } else {
                return `${seconds}s`;
            }
        }

        // Toggle Printer Settings
        function togglePrinterSettings() {
            const printerType = document.getElementById('printerType').value;
            const usbSettings = document.getElementById('usb-settings');
            const networkSettings = document.getElementById('network-settings');
            
            if (printerType === 'usb') {
                usbSettings.style.display = 'block';
                networkSettings.style.display = 'none';
            } else {
                usbSettings.style.display = 'none';
                networkSettings.style.display = 'block';
            }
        }

        // Save Configuration
        document.getElementById('config-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const config = {
                enabled: document.getElementById('enabled').checked,
                printerType: document.getElementById('printerType').value,
                usbVendorId: document.getElementById('usbVendorId').value,
                usbProductId: document.getElementById('usbProductId').value,
                networkHost: document.getElementById('networkHost').value,
                networkPort: parseInt(document.getElementById('networkPort').value),
                printChats: document.getElementById('printChats').checked,
                printGifts: document.getElementById('printGifts').checked,
                printFollows: document.getElementById('printFollows').checked,
                printShares: document.getElementById('printShares').checked,
                minCoinsToPrint: parseInt(document.getElementById('minCoinsToPrint').value),
                ignoreBotCommands: document.getElementById('ignoreBotCommands').checked,
                autoCutPaper: document.getElementById('autoCutPaper').checked,
                width: parseInt(document.getElementById('width').value),
                encoding: document.getElementById('encoding').value,
                reconnectAttempts: parseInt(document.getElementById('reconnectAttempts').value),
                reconnectDelay: parseInt(document.getElementById('reconnectDelay').value),
                queueMaxSize: parseInt(document.getElementById('queueMaxSize').value),
                printDelay: parseInt(document.getElementById('printDelay').value)
            };
            
            try {
                const response = await fetch('/api/thermal-printer/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Configuration saved successfully!');
                    loadStatus();
                } else {
                    alert('Error saving configuration: ' + (data.errors ? data.errors.join(', ') : data.error));
                }
            } catch (error) {
                console.error('Error saving config:', error);
                alert('Error saving configuration!');
            }
        });

        // Test Print
        document.getElementById('test-print-btn').addEventListener('click', async () => {
            try {
                const response = await fetch('/api/thermal-printer/test', {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Test print job queued!');
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Error test printing:', error);
                alert('Error sending test print!');
            }
        });

        // Printer Type Change
        document.getElementById('printerType').addEventListener('change', togglePrinterSettings);

        // Socket.IO Status Updates
        socket.on('thermal-printer:status', (data) => {
            if (data.status) {
                updateStatus(data.status);
            }
        });

        // Initial Load
        loadConfig();
        loadStatus();
        
        // Auto-refresh status every 5 seconds
        setInterval(loadStatus, 5000);
    </script>
</body>
</html>
