<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Level Up Overlay</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: transparent;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      overflow: hidden;
      width: 1920px;
      height: 1080px;
    }

    .level-up-container {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      opacity: 0;
      display: none;
    }

    .level-up-container.show {
      display: block;
      animation: levelUpAppear 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
    }

    @keyframes levelUpAppear {
      0% {
        transform: translate(-50%, -50%) scale(0) rotate(-180deg);
        opacity: 0;
      }
      60% {
        transform: translate(-50%, -50%) scale(1.1) rotate(10deg);
        opacity: 1;
      }
      100% {
        transform: translate(-50%, -50%) scale(1) rotate(0deg);
        opacity: 1;
      }
    }

    .level-up-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 30px;
      padding: 60px 80px;
      text-align: center;
      box-shadow: 
        0 0 60px rgba(102, 126, 234, 0.6),
        0 0 120px rgba(118, 75, 162, 0.4),
        inset 0 0 40px rgba(255, 255, 255, 0.1);
      border: 4px solid rgba(255, 255, 255, 0.3);
      position: relative;
      overflow: hidden;
      min-width: 600px;
    }

    .level-up-card::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
      animation: shine 2s linear infinite;
    }

    @keyframes shine {
      0% {
        transform: rotate(0deg);
      }
      100% {
        transform: rotate(360deg);
      }
    }

    .level-up-title {
      font-size: 48px;
      font-weight: 900;
      color: #fff;
      text-transform: uppercase;
      letter-spacing: 4px;
      margin-bottom: 20px;
      text-shadow: 
        0 0 20px rgba(255, 255, 255, 0.5),
        0 4px 8px rgba(0, 0, 0, 0.3);
      position: relative;
      z-index: 1;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.05);
      }
    }

    .username {
      font-size: 42px;
      font-weight: 700;
      color: #FFD700;
      margin-bottom: 30px;
      text-shadow: 
        0 0 15px rgba(255, 215, 0, 0.8),
        0 4px 8px rgba(0, 0, 0, 0.3);
      position: relative;
      z-index: 1;
    }

    .level-display {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 40px;
      margin: 40px 0;
      position: relative;
      z-index: 1;
    }

    .level-number {
      font-size: 120px;
      font-weight: 900;
      color: #fff;
      text-shadow: 
        0 0 30px rgba(255, 255, 255, 0.8),
        0 8px 16px rgba(0, 0, 0, 0.4);
      line-height: 1;
      min-width: 180px;
    }

    .level-arrow {
      font-size: 60px;
      color: #FFD700;
      animation: slideArrow 1.5s ease-in-out infinite;
    }

    @keyframes slideArrow {
      0%, 100% {
        transform: translateX(0);
      }
      50% {
        transform: translateX(10px);
      }
    }

    .level-number.new {
      animation: levelPop 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55) 0.3s both;
    }

    @keyframes levelPop {
      0% {
        transform: scale(0);
        opacity: 0;
      }
      60% {
        transform: scale(1.2);
      }
      100% {
        transform: scale(1);
        opacity: 1;
      }
    }

    .rewards {
      margin-top: 40px;
      position: relative;
      z-index: 1;
    }

    .reward-title {
      font-size: 32px;
      font-weight: 700;
      color: #fff;
      margin-bottom: 20px;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .reward-badge {
      display: inline-block;
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid rgba(255, 255, 255, 0.4);
      border-radius: 20px;
      padding: 12px 30px;
      margin: 8px;
      font-size: 24px;
      font-weight: 600;
      color: #fff;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      animation: badgeBounce 0.6s ease-out;
      animation-fill-mode: both;
    }

    @keyframes badgeBounce {
      0% {
        transform: scale(0) translateY(50px);
        opacity: 0;
      }
      50% {
        transform: scale(1.1) translateY(0);
      }
      100% {
        transform: scale(1) translateY(0);
        opacity: 1;
      }
    }

    .reward-badge:nth-child(2) {
      animation-delay: 0.1s;
    }

    .reward-badge:nth-child(3) {
      animation-delay: 0.2s;
    }

    .reward-badge:nth-child(4) {
      animation-delay: 0.3s;
    }

    /* Particle effects */
    .particle {
      position: absolute;
      width: 8px;
      height: 8px;
      background: #FFD700;
      border-radius: 50%;
      pointer-events: none;
      animation: particleFall 3s linear infinite;
    }

    @keyframes particleFall {
      0% {
        transform: translateY(0) rotate(0deg);
        opacity: 1;
      }
      100% {
        transform: translateY(1000px) rotate(720deg);
        opacity: 0;
      }
    }

    /* Confetti */
    .confetti {
      position: absolute;
      width: 10px;
      height: 10px;
      background: #f00;
      animation: confettiFall 4s linear infinite;
    }

    @keyframes confettiFall {
      0% {
        transform: translateY(-100px) rotate(0deg);
        opacity: 1;
      }
      100% {
        transform: translateY(1200px) rotate(720deg);
        opacity: 0;
      }
    }

    .level-up-container.hide {
      animation: levelUpDisappear 0.5s ease-out forwards;
    }

    @keyframes levelUpDisappear {
      0% {
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
      }
      100% {
        transform: translate(-50%, -50%) scale(0.5);
        opacity: 0;
      }
    }
  </style>
</head>
<body>
  <div class="level-up-container" id="levelUpContainer">
    <div class="level-up-card">
      <div class="level-up-title">LEVEL UP!</div>
      <div class="username" id="username">Player</div>
      <div class="level-display">
        <div class="level-number" id="oldLevel">1</div>
        <div class="level-arrow">â†’</div>
        <div class="level-number new" id="newLevel">2</div>
      </div>
      <div class="rewards" id="rewards">
        <!-- Rewards will be inserted here -->
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const container = document.getElementById('levelUpContainer');
    const usernameEl = document.getElementById('username');
    const oldLevelEl = document.getElementById('oldLevel');
    const newLevelEl = document.getElementById('newLevel');
    const rewardsEl = document.getElementById('rewards');

    let currentAnimation = null;

    // Parse URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const duration = parseInt(urlParams.get('duration')) || 5000;
    const soundEnabled = urlParams.get('sound') !== 'false';

    // Listen for level-up events
    socket.on('viewer-xp:level-up', (data) => {
      showLevelUp(data);
    });

    function showLevelUp(data) {
      // Clear any existing animation
      if (currentAnimation) {
        clearTimeout(currentAnimation);
        container.classList.remove('show', 'hide');
      }

      // Update content
      usernameEl.textContent = data.username;
      oldLevelEl.textContent = data.oldLevel;
      newLevelEl.textContent = data.newLevel;

      // Build rewards display
      rewardsEl.innerHTML = '';
      if (data.rewards) {
        const rewardTitle = document.createElement('div');
        rewardTitle.className = 'reward-title';
        rewardTitle.textContent = 'ðŸŽ Belohnungen';
        rewardsEl.appendChild(rewardTitle);

        if (data.rewards.title) {
          const badge = document.createElement('div');
          badge.className = 'reward-badge';
          badge.textContent = `âœ¨ ${data.rewards.title}`;
          rewardsEl.appendChild(badge);
        }

        if (data.rewards.name_color) {
          const badge = document.createElement('div');
          badge.className = 'reward-badge';
          badge.textContent = `ðŸŽ¨ Neue Farbe`;
          badge.style.color = data.rewards.name_color;
          rewardsEl.appendChild(badge);
        }

        if (data.rewards.announcement_message) {
          const badge = document.createElement('div');
          badge.className = 'reward-badge';
          badge.textContent = data.rewards.announcement_message.replace('{username}', '');
          rewardsEl.appendChild(badge);
        }
      }

      // Create particles and confetti
      createParticles();
      createConfetti();

      // Show animation
      container.classList.add('show');

      // Play sound (if enabled and available)
      if (soundEnabled) {
        playLevelUpSound();
      }

      // Auto-hide after duration
      currentAnimation = setTimeout(() => {
        container.classList.add('hide');
        setTimeout(() => {
          container.classList.remove('show', 'hide');
        }, 500);
      }, duration);
    }

    function createParticles() {
      const particleCount = 50;
      for (let i = 0; i < particleCount; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        particle.style.left = Math.random() * window.innerWidth + 'px';
        particle.style.top = '-10px';
        particle.style.animationDelay = Math.random() * 2 + 's';
        particle.style.animationDuration = (Math.random() * 2 + 2) + 's';
        document.body.appendChild(particle);

        setTimeout(() => {
          particle.remove();
        }, 5000);
      }
    }

    function createConfetti() {
      const confettiCount = 100;
      const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff', '#ffa500'];
      
      for (let i = 0; i < confettiCount; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.left = Math.random() * window.innerWidth + 'px';
        confetti.style.top = '-10px';
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.animationDelay = Math.random() * 1 + 's';
        confetti.style.animationDuration = (Math.random() * 3 + 3) + 's';
        document.body.appendChild(confetti);

        setTimeout(() => {
          confetti.remove();
        }, 7000);
      }
    }

    function playLevelUpSound() {
      // Create a simple beep sound using Web Audio API
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        // Create a short melody for level up
        const notes = [523.25, 659.25, 783.99, 1046.50]; // C5, E5, G5, C6
        let startTime = audioContext.currentTime;

        notes.forEach((frequency, index) => {
          const oscillator = audioContext.createOscillator();
          const gainNode = audioContext.createGain();
          
          oscillator.connect(gainNode);
          gainNode.connect(audioContext.destination);
          
          oscillator.frequency.value = frequency;
          oscillator.type = 'sine';
          
          const noteStart = startTime + (index * 0.15);
          const noteEnd = noteStart + 0.15;
          
          gainNode.gain.setValueAtTime(0.3, noteStart);
          gainNode.gain.exponentialRampToValueAtTime(0.01, noteEnd);
          
          oscillator.start(noteStart);
          oscillator.stop(noteEnd);
        });
      } catch (error) {
        console.error('Could not play level-up sound:', error);
      }
    }

    // Test mode: trigger level up on page load if test=true
    if (urlParams.get('test') === 'true') {
      setTimeout(() => {
        showLevelUp({
          username: 'TestUser',
          oldLevel: 4,
          newLevel: 5,
          rewards: {
            title: 'Regular Viewer',
            name_color: '#00FF00',
            announcement_message: 'Welcome to level 5!'
          }
        });
      }, 1000);
    }

    console.log('Level-Up Overlay loaded and ready');
    console.log('Add ?test=true to URL to see test animation');
  </script>
</body>
</html>
